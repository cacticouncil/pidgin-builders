environment:
  - ARCH=amd64
  - REPO=pidgin/builders
  - REGISTRY_USERNAME
  - REGISTRY_PASSWORD
  - REGISTRY_HOST=docker.io

tasks:
  import:
    type: docker/import
    files:
      - .:.

  build:
    type: docker/build
    dockerfile: Dockerfile.${DISTRO}-${VERSION}-${ARCH}
    tag: ${REGISTRY_HOST}/${REPO}:${DISTRO}-${VERSION}-${ARCH}
    files:
      - ${FILES}
    labels:
      - COMMIT=${HG_COMMIT}

  publish:
    type: docker/push
    image: ${REGISTRY_HOST}/${REPO}:${DISTRO}-${VERSION}-${ARCH}

  login:
    type: docker/login
    username: ${REGISTRY_USERNAME}
    password: ${REGISTRY_PASSWORD}
    server: ${REGISTRY_HOST}

  logout:
    type: docker/logout
    server: ${REGISTRY_HOST}

plans:
  debian-bullseye-amd64:
    environment: [DISTRO=debian, VERSION=bullseye, FILES=simple]
    stages:
      - tasks: [import, build]
  debian-buster-amd64:
    environment: [DISTRO=debian, VERSION=buster, FILES=simple]
    stages:
      - tasks: [import, build]

  mingw-w64-x86_64:
    environment: [DISTRO=mingw, VERSION=w64, ARCH=x86_64, FILES=mingw]
    stages:
      - tasks: [import, build]

  build:
    stages:
      - tasks: [import, build]

  publish:
    environment: [REGISTRY_USERNAME, REGISTRY_PASSWORD]
    stages:
      - tasks: [login, publish]
      - tasks: [logout]
        run: always
